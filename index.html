<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Student Marks Analyzer</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen flex items-center justify-center
             bg-gradient-to-br from-[#e9f0f8] via-[#f3f6fb] to-[#dbeafe]">

<!-- ================= USER ICON ================= -->
<div class="fixed top-4 right-4 z-[9999]">
  <button id="authBtn"
    class="w-12 h-12 flex items-center justify-center
           rounded-full bg-[#1f3757]
           hover:bg-[#162a44] shadow-lg">
    <svg xmlns="http://www.w3.org/2000/svg"
         viewBox="0 0 24 24"
         fill="none"
         stroke="white"
         stroke-width="2"
         stroke-linecap="round"
         stroke-linejoin="round"
         class="w-6 h-6">
      <path d="M20 21c0-2.8-3.6-5-8-5s-8 2.2-8 5"/>
      <circle cx="12" cy="7" r="4"/>
    </svg>
  </button>

  <!-- DROPDOWN -->
  <div id="userMenu"
    class="hidden absolute right-0 mt-3 w-40
           bg-white rounded-lg shadow-lg border overflow-hidden">
    <button id="profileBtn"
      class="block w-full text-left px-4 py-2 hover:bg-gray-100">
      Profile
    </button>
    <button id="logoutBtn"
      class="block w-full text-left px-4 py-2 text-red-600 hover:bg-gray-100">
      Logout
    </button>
  </div>
</div>

<!-- ================= MAIN CARD ================= -->
<div class="bg-white p-8 rounded-2xl shadow-xl
            w-full max-w-md border border-gray-200">

  <h1 class="text-3xl font-bold text-center mb-6 text-[#1f3757]">
    Student Marks Analyzer
  </h1>

  <!-- ================= FORM ================= -->
  <form id="marksForm" class="space-y-4">

    <input type="number" name="semester" placeholder="Semester Number"
      required min="1" max="8"
      class="w-full p-3 rounded-lg border border-gray-300">

    <input type="number" name="pass_mark" placeholder="Pass / Margin Marks"
      required min="0"
      class="w-full p-3 rounded-lg border border-gray-300">

    <input type="number" id="courseCount" placeholder="Number of Courses"
      required min="1" max="10"
      class="w-full p-3 rounded-lg border border-gray-300">

    <!-- Dynamic courses -->
    <div id="coursesContainer" class="space-y-3"></div>

    <button type="submit"
      class="w-full bg-[#1f3757] text-white py-3 rounded-lg
             text-lg font-semibold hover:bg-[#162a44]">
      Analyze
    </button>
  </form>

  <p id="error" class="text-red-500 text-center mt-4"></p>

  <!-- ================= RESULT ================= -->
  <div id="result"
    class="mt-6 hidden bg-[#dbeafe] p-6 rounded-xl border border-blue-300">

    <h2 class="text-2xl font-bold mb-4 text-[#1f3757]">
      Analysis Result
    </h2>

    <p><strong>Semester:</strong> <span id="semester_result"></span></p>
    <p><strong>Pass Marks:</strong> <span id="pass_mark_result"></span></p>
    <p><strong>Total Courses:</strong> <span id="course_count"></span></p>

    <div id="marks_result" class="mt-3 space-y-1"></div>

    <p class="mt-2"><strong>Total:</strong> <span id="total"></span></p>
    <p><strong>Average:</strong> <span id="average"></span></p>
    <p><strong>Result:</strong> <span id="finalResult"></span></p>
  </div>
</div>

<!-- ================= PROFILE MODAL ================= -->
<div id="profileModal"
  class="hidden fixed inset-0 z-50 flex
         items-center justify-center
         bg-black bg-opacity-50">

  <div class="bg-white w-96 rounded-2xl shadow-xl p-6 relative">

    <button id="closeProfile"
      class="absolute top-3 right-3 text-gray-500 hover:text-gray-800">
      ✕
    </button>

    <h2 class="text-2xl font-bold text-[#1f3757] mb-4">
      ✅ Profile Summary
    </h2>

    <div id="profileData"
      class="space-y-2 text-sm text-gray-700 max-h-64 overflow-y-auto"></div>

    <div class="mt-6 text-right">
      <button id="okProfile"
        class="bg-[#1f3757] text-white px-4 py-2
               rounded-lg hover:bg-[#162a44]">
        OK
      </button>
    </div>
  </div>
</div>

<!-- ================= SCRIPT ================= -->
<script>
/* ---------- Dropdown ---------- */
authBtn.onclick = (e) => {
  e.stopPropagation();
  userMenu.classList.toggle("hidden");
};
document.onclick = () => userMenu.classList.add("hidden");

/* ---------- Logout ---------- */
logoutBtn.onclick = () => window.location.href = "/logout";

/* ---------- Profile ---------- */
profileBtn.onclick = async () => {
  const res = await fetch("/api/profile", { credentials: "include" });
  const data = await res.json();

  let html = `
    <p><strong>Email:</strong> ${data.email}</p>
    <p><strong>Total Analyses:</strong> ${data.totalAnalyses}</p><hr>
  `;

  data.records.forEach((r, i) => {
    html += `
      <p><strong>${i + 1}. Semester ${r.semester}</strong></p>
      <p>Average: ${r.average}</p>
      <p>Result: ${r.result}</p><hr>
    `;
  });

  profileData.innerHTML = html;
  profileModal.classList.remove("hidden");
};

closeProfile.onclick = okProfile.onclick =
  () => profileModal.classList.add("hidden");

/* ---------- Dynamic Courses ---------- */
courseCountInput.oninput = () => {
  coursesContainer.innerHTML = "";
  for (let i = 1; i <= courseCountInput.value; i++) {
    const input = document.createElement("input");
    input.type = "number";
    input.required = true;
    input.placeholder = `Course ${i} Marks`;
    input.dataset.course = "mark";
    input.className = "w-full p-3 rounded-lg border border-gray-300";
    coursesContainer.appendChild(input);
  }
};

/* ---------- Analyze ---------- */
marksForm.onsubmit = async (e) => {
  e.preventDefault();
  error.textContent = "";

  try {
    const semester = +document.querySelector("[name='semester']").value;
    const pass_mark = +document.querySelector("[name='pass_mark']").value;
    const marks = [...document.querySelectorAll("[data-course='mark']")]
                  .map(i => +i.value);

    const res = await fetch("/analyze", {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ semester, pass_mark, courses: marks })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.error);

    semester_result.textContent = data.semester;
    pass_mark_result.textContent = data.pass_mark;
    course_count.textContent = data.total_courses;
    total.textContent = data.total;
    average.textContent = data.average;
    finalResult.textContent = data.result;

    marks_result.innerHTML = "";
    data.marks.forEach((m, i) =>
      marks_result.innerHTML += `<p>Course ${i+1}: ${m}</p>`
    );

    result.classList.remove("hidden");

    await fetch("/api/save-marks", {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

  } catch (err) {
    error.textContent = err.message;
  }
};
</script>

</body>
</html>
